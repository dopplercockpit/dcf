<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="api-base" content="http://127.0.0.1:5000">
    <title>Enhanced DCF Model - Educational Analysis Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header .features {
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .content {
            padding: 40px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            cursor: pointer;
        }

        .alert.error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert.success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }

        .alert.active {
            display: block;
        }

        /* INPUT SECTION */
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            margin-bottom: 30px;
        }

        .ticker-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .ticker-input-group > div {
            flex: 1;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* LOADING */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESULTS SECTION */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        /* TWO-COLUMN LAYOUT FOR RESULTS */
        .results-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-results {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* SENTIMENT FEED */
        .sentiment-feed {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            max-height: 800px;
            overflow-y: auto;
        }

        .sentiment-feed h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .sentiment-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sentiment-card .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: none;
            padding: 0;
            color: #333;
        }

        .sentiment-card .source {
            font-weight: 600;
            font-size: 0.85em;
            color: #667eea;
        }

        .sentiment-card .score {
            font-size: 1.5em;
        }

        .sentiment-gauge {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .sentiment-gauge-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .sentiment-gauge-fill.positive {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .sentiment-gauge-fill.neutral {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .sentiment-gauge-fill.negative {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .news-item, .reddit-item {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .news-item:last-child, .reddit-item:last-child {
            border-bottom: none;
        }

        .news-item .title, .reddit-item .title {
            font-weight: 600;
            font-size: 0.9em;
            color: #1e3c72;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .news-item .meta, .reddit-item .meta {
            font-size: 0.75em;
            color: #666;
        }

        .news-item a, .reddit-item a {
            color: #667eea;
            text-decoration: none;
        }

        .news-item a:hover, .reddit-item a:hover {
            text-decoration: underline;
        }

        /* SECTION STYLING */
        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .section-title {
            font-size: 1.8em;
            color: #1e3c72;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* ENHANCED TOOLTIPS */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 2px dotted #667eea;
        }

        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            background: #1e3c72;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.6;
            width: 400px;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: opacity 0.3s, visibility 0.3s;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #1e3c72 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text .formula {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        .tooltip-text .learn-more {
            display: block;
            margin-top: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            text-align: center;
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .tooltip-text .learn-more:hover {
            background: rgba(255,255,255,0.3);
        }

        /* COMPARISON SECTION */
        .comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .comparison-value {
            font-size: 2em;
            font-weight: 700;
            color: #1e3c72;
        }

        .arrow {
            font-size: 3em;
            color: #667eea;
        }

        .arrow.up {
            color: #10b981;
        }

        .arrow.down {
            color: #ef4444;
        }

        /* INFO BOX */
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .info-box p {
            margin: 5px 0;
            color: #1565c0;
        }

        .info-box.warning {
            background: #fff3cd;
            border-left-color: #f59e0b;
        }

        .info-box.warning p {
            color: #92400e;
        }

        .info-box.danger {
            background: #fee;
            border-left-color: #ef4444;
        }

        .info-box.danger p {
            color: #991b1b;
        }

        /* RESULTS GRID */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border-top: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }

        .result-card.positive {
            border-top-color: #10b981;
        }

        .result-card.negative {
            border-top-color: #ef4444;
        }

        .result-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .result-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1e3c72;
        }

        .result-value.positive {
            color: #10b981;
        }

        .result-value.negative {
            color: #ef4444;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .sensitivity-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0 0;
            font-size: 0.85em;
            box-shadow: none;
        }

        .sensitivity-matrix th,
        .sensitivity-matrix td {
            padding: 8px 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .sensitivity-matrix th {
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 600;
        }

        .sensitivity-cell {
            font-weight: 600;
            color: #0f172a;
        }

        .sensitivity-cell.na {
            color: #9ca3af;
            font-weight: 500;
        }

        .explanation-item {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #eef2f7;
        }

        .explanation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1e3c72;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e7f3ff;
            color: #1e3c72;
            font-size: 0.75em;
            cursor: help;
        }

        .details-panel {
            margin-top: 8px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px 12px;
        }

        .details-panel summary {
            cursor: pointer;
            font-weight: 600;
            color: #374151;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px 16px;
            margin-top: 10px;
            font-size: 0.85em;
            color: #4b5563;
        }

        .details-label {
            font-weight: 600;
            color: #1f2937;
        }

        .run-log {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .run-log-item {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 0.85em;
        }

        .run-log-item.error {
            border-color: #fecaca;
            background: #fef2f2;
        }

        .run-log-item.warning {
            border-color: #fde68a;
            background: #fffbeb;
        }

        .run-log-item .meta {
            color: #6b7280;
            font-size: 0.85em;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1200px) {
            .results-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .ticker-input-group {
                flex-direction: column;
            }

            .comparison {
                flex-direction: column;
                gap: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .tooltip-text {
                width: 280px;
            }
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .input-subsection {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .input-subsection h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .range-value {
            font-weight: 600;
            color: #1e3c72;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Enhanced DCF Valuation Model</h1>
            <p class="subtitle">Comprehensive Stock Analysis with Transparency & Education</p>
            <p class="features">
                âœ¨ Interactive Tooltips â€¢ ðŸ“± Reddit Sentiment â€¢ ðŸ“° News Analysis â€¢ ðŸ”— Educational Links
            </p>
        </div>



        <div class="content">
            <div class="alert" id="alert"></div>

            <!-- Input Section -->
            <div class="input-section" id="input-section">
                <div class="ticker-input-group">
                    <div class="input-group" style="flex: 2;">
                        <label>Ticker Symbol *</label>
                        <input type="text" id="ticker" placeholder="e.g., AAPL, MSFT, GOOGL, TSLA"
                               style="text-transform: uppercase;">
                        <p class="help-text">Enter any US stock ticker symbol for comprehensive analysis</p>
                    </div>
                    <div style="flex: 1;">
                        <button class="button" onclick="analyzeStock()" id="analyze-btn">
                            ðŸš€ Analyze Stock
                        </button>
                    </div>
                </div>

                <div class="input-subsection">
                    <h3>Sustainable Finance (ESG)</h3>
                    <div class="input-grid">
                        <div class="input-group">
                        <label>
                            <input type="checkbox" id="esg-enabled" checked>
                            Enable ESG Adjustment
                        </label>
                        <p class="help-text">Apply a green discounting adjustment to cost of equity.</p>
                    </div>
                    <div class="input-group">
                        <label for="esg-strength-bps">
                            ESG Strength (bps)
                            <span class="range-value" id="esg-strength-value">50</span>
                        </label>
                        <input type="range" id="esg-strength-bps" min="0" max="150" value="50">
                    </div>
                    </div>
                </div>

                <div class="input-subsection">
                    <h3>Resilience Stress Test</h3>
                    <div class="input-grid">
                        <div class="input-group">
                        <label>
                            <input type="checkbox" id="stress-enabled">
                            Enable Stress Test
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="stress-supply-chain">
                            Supply Chain Shock
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="stress-carbon-tax">
                            Carbon Tax
                        </label>
                    </div>
                    <div class="input-group">
                        <label>Carbon Intensity</label>
                        <input type="number" id="carbon-intensity" value="0.02" step="0.01" min="0" max="1">
                    </div>
                    <div class="input-group">
                        <label>Carbon Tax Rate</label>
                        <input type="number" id="carbon-tax-rate" value="0.01" step="0.01" min="0" max="1">
                    </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p><strong>Comprehensive Analysis in Progress...</strong></p>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    Fetching financial data, scraping Reddit sentiment, and analyzing news...
                </p>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="results-section">
                <div class="results-layout">
                    <!-- Main Results -->
                    <div class="main-results">
                        <div id="results-container"></div>
                        <div id="explanation-container"></div>
                    </div>

                    <!-- Sidebar with Sentiment Feed -->
                    <div class="sidebar">
                        <div class="sentiment-feed" id="sentiment-feed">
                            <h3>ðŸ“Š Market Sentiment</h3>
                            <div id="sentiment-content"></div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="button" onclick="showExplanation()" style="width: auto; padding: 15px 40px; margin-right: 10px;">
                        Show Step-by-Step Explanation
                    </button>
                    <button class="button" onclick="downloadExcel()" style="width: auto; padding: 15px 40px; margin-right: 10px;">
                        Download Excel
                    </button>
                    <button class="button" onclick="resetAnalysis()" style="width: auto; padding: 15px 40px;">
                        ðŸ”„ Analyze Another Stock
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type + ' active';
            alert.title = 'Click to dismiss';
            alert.onclick = () => alert.classList.remove('active');

            const timeoutMs = type === 'error' ? 0 : 5000;
            if (timeoutMs > 0) {
                setTimeout(() => {
                    alert.classList.remove('active');
                }, timeoutMs);
            }
        }

        let latestResults = null;
        const API_BASE = (document.querySelector('meta[name="api-base"]')?.content || '').replace(/\/$/, '');

        function apiUrl(path) {
            if (!API_BASE) {
                return path;
            }
            return `${API_BASE}${path}`;
        }

        async function analyzeStock() {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();

            if (!ticker) {
                showAlert('Please enter a ticker symbol');
                return;
            }

            const esgEnabled = document.getElementById('esg-enabled').checked;
            const esgStrength = parseFloat(document.getElementById('esg-strength-bps').value);
            const stressEnabled = document.getElementById('stress-enabled').checked;
            const stressSupplyChain = document.getElementById('stress-supply-chain').checked;
            const stressCarbonTax = document.getElementById('stress-carbon-tax').checked;
            const carbonIntensity = parseFloat(document.getElementById('carbon-intensity').value);
            const carbonTaxRate = parseFloat(document.getElementById('carbon-tax-rate').value);

            const assumptions = {
                esg_adjustment_enabled: esgEnabled,
                esg_strength_bps: isNaN(esgStrength) ? 50 : esgStrength,
                stress_enabled: stressEnabled,
                stress_supply_chain: stressSupplyChain,
                stress_carbon_tax: stressCarbonTax,
                carbon_intensity: isNaN(carbonIntensity) ? 0.02 : carbonIntensity,
                carbon_tax_rate: isNaN(carbonTaxRate) ? 0.01 : carbonTaxRate
            };

            // Show loading, hide input and results
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('results-section').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            document.getElementById('analyze-btn').disabled = true;

            try {
                const response = await fetch(apiUrl('/api/analyze'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        assumptions: assumptions
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.success) {
                    latestResults = data.results;
                    try {
                        displayResults(data.results);
                        displaySentimentFeed(data.results);
                    } catch (renderError) {
                        console.error('Render error:', renderError);
                        showAlert('Error rendering results: ' + renderError.message);
                        displayRawResults(data.results);
                    }
                    document.getElementById('results-section').classList.add('active');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'));
                    document.getElementById('input-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Full error:', error);
                showAlert('Error analyzing stock: ' + error.message);
                document.getElementById('input-section').style.display = 'block';
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('analyze-btn').disabled = false;
            }
        }

        function resetAnalysis() {
            document.getElementById('results-section').classList.remove('active');
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('ticker').value = '';
            document.getElementById('ticker').focus();
            document.getElementById('explanation-container').innerHTML = '';
            latestResults = null;
        }

        function displayRawResults(results) {
            const container = document.getElementById('results-container');
            const explanation = document.getElementById('explanation-container');
            explanation.innerHTML = '';

            const json = JSON.stringify(results, null, 2);
            container.innerHTML = `
                <div class="section">
                    <h2 class="section-title">Raw Results (Fallback)</h2>
                    <pre style="background:#0f172a;color:#e2e8f0;padding:20px;border-radius:12px;overflow:auto;max-height:60vh;">
${json}
                    </pre>
                </div>
            `;
        }

        async function showExplanation() {
            if (!latestResults) {
                showAlert('Run an analysis first.');
                return;
            }

            try {
                const response = await fetch(apiUrl('/api/explain'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({results: latestResults})
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate explanation');
                }

                displayExplanation(data.explanation);
            } catch (error) {
                showAlert('Error generating explanation: ' + error.message);
            }
        }

        function formatDetailValue(value) {
            if (value === null || value === undefined) return 'N/A';
            if (typeof value === 'object') {
                try {
                    return `<pre style="margin:4px 0;white-space:pre-wrap;">${JSON.stringify(value, null, 2)}</pre>`;
                } catch (e) {
                    return String(value);
                }
            }
            return String(value);
        }

        function renderKeyValues(obj) {
            if (!obj || typeof obj !== 'object') return '<div>N/A</div>';
            return Object.entries(obj).map(([key, value]) => (
                `<div><span class="details-label">${key}:</span> ${formatDetailValue(value)}</div>`
            )).join('');
        }

        function renderDetails(details, calculation) {
            if (!details && !calculation) return '';
            const formula = details?.formula;
            const inputs = details?.inputs;
            const intermediate = details?.intermediate;
            const provenance = details?.provenance;
            return `
                <details class="details-panel">
                    <summary>Details</summary>
                    <div class="details-grid">
                        ${formula ? `<div><div class="details-label">Formula</div>${formatDetailValue(formula)}</div>` : ''}
                        ${calculation ? `<div><div class="details-label">Calculation</div>${formatDetailValue(calculation)}</div>` : ''}
                        ${inputs ? `<div><div class="details-label">Inputs</div>${renderKeyValues(inputs)}</div>` : ''}
                        ${intermediate ? `<div><div class="details-label">Intermediate</div>${renderKeyValues(intermediate)}</div>` : ''}
                        ${provenance ? `<div><div class="details-label">Provenance</div>${renderKeyValues(provenance)}</div>` : ''}
                    </div>
                </details>
            `;
        }

        function renderTable(table) {
            if (!table) return '';
            const header = table.columns?.length
                ? `<tr>${table.columns.map(col => `<th>${col}</th>`).join('')}</tr>`
                : '';
            const rows = (table.rows || []).map(row => (
                `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
            )).join('');
            return `
                <div style="margin-top: 10px;">
                    ${table.title ? `<h4 style="margin: 10px 0;">${table.title}</h4>` : ''}
                    <table>${header}${rows}</table>
                </div>
            `;
        }

        function renderRunLog(runLog, summary) {
            if (!runLog || !runLog.length) {
                return '<p style="color:#6b7280;">No run log entries.</p>';
            }

            const groups = { error: [], warning: [], info: [] };
            runLog.forEach(entry => {
                const level = entry.level || 'info';
                if (!groups[level]) groups[level] = [];
                groups[level].push(entry);
            });

            const summaryHtml = summary?.counts
                ? `<p class="meta">Summary: ${JSON.stringify(summary.counts)}</p>`
                : '';

            const renderEntries = (entries, levelLabel) => {
                if (!entries.length) return '';
                return `
                    <div style="margin-top: 10px;">
                        <strong>${levelLabel}</strong>
                        <div class="run-log">
                            ${entries.map(entry => {
                                const metaParts = [
                                    entry.ts ? `Time: ${entry.ts}` : null,
                                    entry.subsystem ? `Subsystem: ${entry.subsystem}` : null,
                                    entry.source ? `Source: ${entry.source}` : null,
                                    entry.code ? `Code: ${entry.code}` : null,
                                    entry.action ? `Action: ${entry.action}` : null,
                                ].filter(Boolean);
                                const meta = metaParts.join(' | ');
                                const details = entry.meta ? `Meta: ${JSON.stringify(entry.meta)}` : '';
                                return `
                                    <div class="run-log-item ${entry.level}">
                                        <div><strong>${entry.message}</strong></div>
                                        ${meta ? `<div class="meta">${meta}</div>` : ''}
                                        ${details ? `<div class="meta">${details}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            };

            return `
                ${summaryHtml}
                ${renderEntries(groups.error, 'Errors')}
                ${renderEntries(groups.warning, 'Warnings')}
                ${renderEntries(groups.info, 'Info')}
            `;
        }

        function displayExplanation(explanation) {
            const container = document.getElementById('explanation-container');
            if (!explanation || !explanation.sections) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="section"><h2 class="section-title">Step-by-Step Calculation Walkthrough</h2>';

            explanation.sections.forEach(section => {
                html += `<h3 style="color: #1e3c72; margin: 20px 0 10px;">${section.title}</h3>`;
                if (section.formula) {
                    html += `<div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin: 10px 0; font-family: monospace;">${section.formula}</div>`;
                }
                if (section.explanation) {
                    html += `<p style="color: #666;">${section.explanation}</p>`;
                }
                if (section.tables && section.tables.length) {
                    section.tables.forEach(table => {
                        html += renderTable(table);
                    });
                }
                if (section.items && section.items.length) {
                    section.items.forEach(item => {
                        const tooltip = item.tooltip || item.explanation || '';
                        html += `<div class="explanation-item">`;
                        html += `<div class="explanation-header">`;
                        html += `<span>${item.label}:</span>`;
                        html += `<span style="font-weight: 700; color:#111827;">${item.value}</span>`;
                        if (tooltip) {
                            html += `<span class="info-icon" title="${tooltip}">i</span>`;
                        }
                        html += `</div>`;
                        if (item.calculation) {
                            html += `<div style="color: #667eea; margin-top: 4px;">${item.calculation}</div>`;
                        }
                        if (item.explanation) {
                            html += `<div style="color: #6b7280; font-size: 0.9em;">${item.explanation}</div>`;
                        }
                        html += renderDetails(item.details, item.calculation);
                        html += `</div>`;
                    });
                }
                if (section.run_log) {
                    html += renderRunLog(section.run_log, section.summary);
                }
            });

            if (explanation.key_assumptions) {
                html += '<h3 style="color: #1e3c72; margin: 20px 0 10px;">Key Assumptions</h3>';
                html += '<div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
                Object.entries(explanation.key_assumptions).forEach(([key, value]) => {
                    html += `<div><strong>${key}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }

            if (explanation.final_verdict) {
                html += '<div class="info-box">';
                html += `<p><strong>Intrinsic Value:</strong> ${explanation.final_verdict.intrinsic_value}</p>`;
                html += `<p><strong>Market Price:</strong> ${explanation.final_verdict.market_price}</p>`;
                html += `<p><strong>Upside:</strong> ${explanation.final_verdict.upside}</p>`;
                html += `<p><strong>Recommendation:</strong> ${explanation.final_verdict.recommendation}</p>`;
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        async function downloadExcel() {
            if (!latestResults) {
                showAlert('Run an analysis first.');
                return;
            }

            try {
                const response = await fetch(apiUrl('/api/export_excel'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: latestResults
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 200)}`);
                }

                const blob = await response.blob();
                const ticker = latestResults.company_data?.ticker || 'MODEL';
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `DCF_${ticker}.xlsx`;
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (error) {
                showAlert('Error exporting Excel: ' + error.message);
            }
        }

        // SEC-style number formatting helpers
        function formatMoney(value) {
            // Format as $X,XXX with thousand separators, negatives in red parentheses
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            const absVal = Math.abs(value);
            const formatted = Math.round(absVal).toLocaleString('en-US');
            if (value < 0) {
                return `<span style="color: #ef4444;">($${formatted})</span>`;
            }
            return `$${formatted}`;
        }

        function formatPercent(value) {
            // Format as X.X% with one decimal, negatives in red parentheses
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            const pct = value * 100;
            const formatted = Math.abs(pct).toFixed(1);
            if (pct < 0) {
                return `<span style="color: #ef4444;">(${formatted}%)</span>`;
            }
            return `${formatted}%`;
        }

        function formatMultiple(value) {
            // Format as Xx rounded to integer, negatives in red parentheses
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            const rounded = Math.round(Math.abs(value));
            if (value < 0) {
                return `<span style="color: #ef4444;">(${rounded}x)</span>`;
            }
            return `${rounded}x`;
        }

        function getHeatmapColor(value, minValue, maxValue) {
            if (value === null || value === undefined || !isFinite(value)) {
                return '#f3f4f6';
            }
            if (minValue === null || maxValue === null || minValue === maxValue) {
                return '#e5e7eb';
            }
            const ratio = Math.max(0, Math.min(1, (value - minValue) / (maxValue - minValue)));
            const start = { r: 254, g: 226, b: 226 };
            const end = { r: 220, g: 252, b: 231 };
            const r = Math.round(start.r + (end.r - start.r) * ratio);
            const g = Math.round(start.g + (end.g - start.g) * ratio);
            const b = Math.round(start.b + (end.b - start.b) * ratio);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function renderSensitivityMatrix(sensitivity) {
            const matrix = sensitivity.matrix || [];
            if (!Array.isArray(matrix) || matrix.length === 0) {
                return '';
            }
            const waccRange = sensitivity.wacc_range || [];
            const growthRange = sensitivity.growth_range || [];
            const rowLabels = waccRange.length === matrix.length
                ? waccRange.map(value => `${(value * 100).toFixed(2)}%`)
                : matrix.map((_, i) => `Row ${i + 1}`);
            const colLabels = growthRange.length === (matrix[0] || []).length
                ? growthRange.map(value => `${(value * 100).toFixed(2)}%`)
                : (matrix[0] || []).map((_, i) => `Col ${i + 1}`);

            let html = `
                <div class="section">
                    <h2 class="section-title">Sensitivity Analysis: WACC vs Terminal Growth</h2>
                    <p style="font-size: 0.85em; color: #6b7280;">
                        Values are intrinsic value per share under different discount rates and terminal growth assumptions.
                    </p>
                    <table class="sensitivity-matrix">
                        <tr>
                            <th>WACC \\ Growth</th>
                            ${colLabels.map(label => `<th>${label}</th>`).join('')}
                        </tr>
            `;

            matrix.forEach((row, rowIndex) => {
                html += `<tr><th>${rowLabels[rowIndex]}</th>`;
                row.forEach((value) => {
                    const isValid = value !== null && value !== undefined && isFinite(value);
                    const bg = getHeatmapColor(value, sensitivity.min_value, sensitivity.max_value);
                    const display = isValid ? `$${value.toFixed(2)}` : 'N/A';
                    html += `<td class="sensitivity-cell ${isValid ? '' : 'na'}" style="background: ${bg};">${display}</td>`;
                });
                html += '</tr>';
            });

            html += '</table></div>';
            return html;
        }

        function formatNumber(value) {
            // Format plain numbers with thousand separators, negatives in red parentheses
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            const formatted = Math.abs(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (value < 0) {
                return `<span style="color: #ef4444;">(${formatted})</span>`;
            }
            return formatted;
        }

        function createTooltip(label, details, investopediaLink) {
            const formula = details.formula || '';
            const explanation = details.explanation || '';
            const components = details.components || {};

            // Acronym mappings matching formula variables exactly
            const acronymMap = {
                // WACC formula: WACC = (E/V Ã— Re) + (D/V Ã— Rd Ã— (1-T))
                'risk_free_rate': 'Rf',
                'market_risk_premium': 'MRP',
                'beta': 'Î²',
                'cost_of_equity': 'Re',
                'cost_of_debt': 'Rd',
                'after_tax_cost_debt': 'RdÃ—(1-T)',
                'tax_rate': 'T',
                'equity_weight': 'E/V',
                'debt_weight': 'D/V',
                'market_cap': 'E',
                'net_debt': 'D',
                'enterprise_value': 'EV',
                'wacc': 'WACC',
                // Terminal Value formula: TV = FCF(final) Ã— (1 + g) / (WACC - g)
                'final_fcf': 'FCF(final)',
                'growth_rate': 'g',
                'perpetual_growth_rate': 'g',
                'terminal_value': 'TV',
                // FCF formula: FCF = Operating Cash Flow - Capital Expenditures
                'ttm_operating_cf': 'OCF',
                'ttm_capex': 'CapEx',
                'ttm_fcf': 'FCF',
                // Equity Value formula: Equity Value = Enterprise Value - Total Debt + Cash
                'total_debt': 'Total Debt',
                'cash': 'Cash',
                'equity_value': 'Equity Value',
                // Intrinsic Value formula: Intrinsic Value = Equity Value / Shares Outstanding
                'shares_outstanding': 'Shares',
                'intrinsic_value': 'IV'
            };

            let componentText = '';
            for (const [key, value] of Object.entries(components)) {
                const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const acronym = acronymMap[key] ? ` (${acronymMap[key]})` : '';
                let displayValue = value;

                if (typeof value === 'number') {
                    if (key.includes('rate') || key.includes('weight') || key.includes('tax')) {
                        // Percentages: one decimal place
                        const pct = value * 100;
                        if (pct < 0) {
                            displayValue = `<span style="color: #ef4444;">(${Math.abs(pct).toFixed(1)}%)</span>`;
                        } else {
                            displayValue = `${pct.toFixed(1)}%`;
                        }
                    } else if (key.includes('multiple')) {
                        // Multiples: rounded to integer
                        displayValue = value < 0
                            ? `<span style="color: #ef4444;">(${Math.round(Math.abs(value))}x)</span>`
                            : `${Math.round(value)}x`;
                    } else {
                        // Money values: thousand separators
                        const formatted = Math.round(Math.abs(value)).toLocaleString('en-US');
                        if (value < 0) {
                            displayValue = `<span style="color: #ef4444;">($${formatted})</span>`;
                        } else {
                            displayValue = `$${formatted}`;
                        }
                    }
                }

                componentText += `<strong>${displayKey}${acronym}:</strong> ${displayValue}<br>`;
            }

            return `
                <span class="tooltip-container">
                    ${label} â“˜
                    <span class="tooltip-text">
                        ${formula ? `<div class="formula">${formula}</div>` : ''}
                        ${componentText ? `<div style="margin: 10px 0;">${componentText}</div>` : ''}
                        ${explanation ? `<p style="margin-top: 10px;">${explanation}</p>` : ''}
                        ${investopediaLink ? `<a href="${investopediaLink}" target="_blank" class="learn-more">ðŸ“š Learn More on Investopedia</a>` : ''}
                    </span>
                </span>
            `;
        }

        function normalizeResults(rawResults) {
            const safe = rawResults || {};
            const stress = safe.stress_test || {};
            const stressScenarios = stress.scenarios || {};

            return {
                ...safe,
                current_market_value: Number(safe.current_market_value || 0),
                intrinsic_value_per_share: Number(safe.intrinsic_value_per_share || 0),
                upside_pct: Number(safe.upside_pct || 0),
                irr: Number(safe.irr || 0),
                enterprise_value_dcf: Number(safe.enterprise_value_dcf || 0),
                equity_value: Number(safe.equity_value || 0),
                terminal_value: Number(safe.terminal_value || 0),
                pv_terminal_value: Number(safe.pv_terminal_value || 0),
                projected_fcf: Array.isArray(safe.projected_fcf) ? safe.projected_fcf : [],
                pv_fcf: Array.isArray(safe.pv_fcf) ? safe.pv_fcf : [],
                company_data: safe.company_data || {},
                historical_data: {
                    quarters: [],
                    operating_cash_flow: [],
                    capex: [],
                    net_income: [],
                    ...(safe.historical_data || {})
                },
                historical_metrics: {
                    quarterly_fcf: [],
                    ttm_operating_cf: 0,
                    ttm_capex: 0,
                    ttm_fcf: 0,
                    ttm_net_income: 0,
                    ...(safe.historical_metrics || {})
                },
                wacc_results: {
                    wacc: 0,
                    cost_of_equity: 0,
                    ke_before_esg: 0,
                    ke_after_esg: 0,
                    market_cap: 0,
                    ...(safe.wacc_results || {})
                },
                assumptions: {
                    revenue_growth_rates: [],
                    perpetual_growth_rate: 0,
                    ...(safe.assumptions || {})
                },
                stress_test: {
                    enabled: false,
                    scenarios: {
                        supply_chain_shock: false,
                        carbon_tax: false,
                        ...stressScenarios
                    },
                    ...stress
                },
                sensitivity: {
                    wacc_range: [],
                    growth_range: [],
                    matrix: [],
                    min_value: null,
                    max_value: null,
                    base_wacc: 0,
                    base_growth: 0,
                    ...(safe.sensitivity || {})
                }
            };
        }

        function displayResults(results) {
            results = normalizeResults(results);
            const container = document.getElementById('results-container');
            document.getElementById('explanation-container').innerHTML = '';
            const company = results.company_data;
            const upside = results.upside_pct;
            const details = results.calculation_details || {};
            const esg = results.esg || {};
            const stress = results.stress_test || {};
            const sensitivity = results.sensitivity || {};

            const esgScore = esg.total_esg;
            const hasEsg = esgScore !== null && esgScore !== undefined;
            const esgMetaParts = [];
            if (esg.source) {
                esgMetaParts.push(`Source: ${esg.source}`);
            }
            if (typeof esg.is_estimated === 'boolean') {
                esgMetaParts.push(`Estimated: ${esg.is_estimated ? 'yes' : 'no'}`);
            }
            if (esg.confidence) {
                esgMetaParts.push(`Confidence: ${String(esg.confidence).replace(/_/g, ' ')}`);
            }
            const esgMeta = esgMetaParts.length
                ? `<p style="font-size: 0.85em; color: #6b7280;">${esgMetaParts.join(' | ')}</p>`
                : '';
            const esgNote = esg.note
                ? `<p style="font-size: 0.85em; color: #6b7280;">${esg.note}</p>`
                : '';
            const esgHtml = hasEsg ? `
                <div class="section">
                    <h2 class="section-title">Sustainable Finance (ESG)</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">Total ESG Score</div>
                            <div class="result-value">${esg.total_esg.toFixed(1)}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Environment</div>
                            <div class="result-value">${esg.environment_score !== null && esg.environment_score !== undefined ? esg.environment_score.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Social</div>
                            <div class="result-value">${esg.social_score !== null && esg.social_score !== undefined ? esg.social_score.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Governance</div>
                            <div class="result-value">${esg.governance_score !== null && esg.governance_score !== undefined ? esg.governance_score.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Controversy</div>
                            <div class="result-value">${esg.controversy_level !== null && esg.controversy_level !== undefined ? esg.controversy_level.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Ke Before/After ESG</div>
                            <div class="result-value">
                                ${(results.wacc_results.ke_before_esg * 100).toFixed(1)}% -> ${(results.wacc_results.ke_after_esg * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    ${esgMeta}
                    ${esgNote}
                </div>
            ` : '';

            const stressBase = stress.base_intrinsic_value_per_share !== null && stress.base_intrinsic_value_per_share !== undefined
                ? stress.base_intrinsic_value_per_share
                : results.intrinsic_value_per_share;
            const stressValue = stress.stressed_intrinsic_value_per_share !== null && stress.stressed_intrinsic_value_per_share !== undefined
                ? stress.stressed_intrinsic_value_per_share
                : stressBase;
            const stressDelta = stress.delta_pct;

            const stressHtml = stress.enabled ? `
                <div class="section">
                    <h2 class="section-title">Resilience Stress Test</h2>
                    <div class="comparison">
                        <div class="comparison-item">
                            <div class="comparison-label">Base Intrinsic Value</div>
                            <div class="comparison-value">$${stressBase.toFixed(2)}</div>
                        </div>
                        <div class="arrow ${stressDelta < 0 ? 'down' : 'up'}">
                            ${stressDelta < 0 ? 'v' : '^'}
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Stressed Intrinsic Value</div>
                            <div class="comparison-value">$${stressValue.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">Delta</div>
                            <div class="result-value ${stressDelta < 0 ? 'negative' : 'positive'}">
                                ${stressDelta !== null && stressDelta !== undefined ? stressDelta.toFixed(1) + '%' : 'N/A'}
                            </div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Supply Chain Shock</div>
                            <div class="result-value">${stress.scenarios.supply_chain_shock ? 'On' : 'Off'}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Carbon Tax</div>
                            <div class="result-value">${stress.scenarios.carbon_tax ? 'On' : 'Off'}</div>
                        </div>
                    </div>
                </div>
            ` : '';

            const sensitivityHtml = renderSensitivityMatrix(sensitivity);

            // Determine recommendation
            let recommendation, returnText, arrowHTML, arrowClass;
            const formattedUpside = upside < 0
                ? `<span style="color: #ef4444;">(${Math.abs(upside).toFixed(1)}%)</span>`
                : `${upside.toFixed(1)}%`;

            if (upside >= 20) {
                recommendation = 'ðŸŸ¢ STRONG BUY - Significantly undervalued';
                returnText = `Potential upside of ${upside.toFixed(1)}% to fair value`;
                arrowHTML = 'â†—'; arrowClass = 'arrow up';
            } else if (upside >= 10) {
                recommendation = 'ðŸŸ¢ BUY - Moderately undervalued';
                returnText = `Potential upside of ${upside.toFixed(1)}% to fair value`;
                arrowHTML = 'â†—'; arrowClass = 'arrow up';
            } else if (upside >= -10) {
                recommendation = 'ðŸŸ¡ HOLD - Fairly valued';
                returnText = `Trading near fair value (${upside >= 0 ? upside.toFixed(1) + '% upside' : '(' + Math.abs(upside).toFixed(1) + '%) downside'})`;
                arrowHTML = 'â†’'; arrowClass = 'arrow';
            } else {
                recommendation = 'ðŸ”´ SELL - Overvalued';
                returnText = `Potential downside of (${Math.abs(upside).toFixed(1)}%) to fair value`;
                arrowHTML = 'â†˜'; arrowClass = 'arrow down';
            }

            container.innerHTML = `
                <div class="section">
                    <h2 class="section-title">ðŸ’° Valuation Results: ${company.company_name} (${company.ticker})</h2>

                    <div class="comparison">
                        <div class="comparison-item">
                            <div class="comparison-label">Market Price</div>
                            <div class="comparison-value">$${results.current_market_value.toFixed(2)}</div>
                        </div>
                        <div class="${arrowClass}">${arrowHTML}</div>
                        <div class="comparison-item">
                            <div class="comparison-label">
                                ${createTooltip('Intrinsic Value', {
                                    formula: 'Intrinsic Value = Equity Value / Shares Outstanding',
                                    components: {
                                        equity_value: results.equity_value,
                                        shares_outstanding: company.shares_outstanding,
                                        intrinsic_value: results.intrinsic_value_per_share
                                    },
                                    explanation: 'The intrinsic value is what the company is truly worth based on its future cash flows, adjusted to present value.'
                                }, 'https://www.investopedia.com/terms/i/intrinsicvalue.asp')}
                            </div>
                            <div class="comparison-value">$${results.intrinsic_value_per_share.toFixed(2)}</div>
                        </div>
                    </div>

                    <p style="font-size: 0.75em; color: #666; text-align: right; margin-top: 5px;"><em>All dollar amounts in millions (M) unless otherwise noted</em></p>

                    <div class="info-box">
                        <p><strong>Recommendation:</strong> ${recommendation}</p>
                        <p><strong>Potential Return:</strong> ${returnText}</p>
                    </div>

                    <div class="results-grid">
                        <div class="result-card ${upside >= 0 ? 'positive' : 'negative'}">
                            <div class="result-label">Upside/Downside</div>
                            <div class="result-value ${upside >= 0 ? 'positive' : 'negative'}">
                                ${upside >= 0 ? '+' + upside.toFixed(1) + '%' : '<span style="color: #ef4444;">(' + Math.abs(upside).toFixed(1) + '%)</span>'}
                            </div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('WACC', details.wacc || {}, 'https://www.investopedia.com/terms/w/wacc.asp')}
                            </div>
                            <div class="result-value">${(results.wacc_results.wacc * 100).toFixed(1)}%</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('Cost of Equity', {
                                    formula: 'Ke = Rf + (Beta Ã— Market Risk Premium)',
                                    components: details.wacc?.components || {},
                                    explanation: 'The return shareholders expect for investing in this company, calculated using the Capital Asset Pricing Model (CAPM).'
                                }, 'https://www.investopedia.com/terms/c/costofequity.asp')}
                            </div>
                            <div class="result-value">${(results.wacc_results.cost_of_equity * 100).toFixed(1)}%</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('IRR', {
                                    explanation: 'Internal Rate of Return - the annualized return you would earn by buying at current price and receiving the projected cash flows.'
                                }, 'https://www.investopedia.com/terms/i/irr.asp')}
                            </div>
                            <div class="result-value">${(results.irr * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div class="results-grid" style="margin-top: 20px;">
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('Enterprise Value', {
                                    explanation: 'The total value of the business, including both equity and debt, calculated from discounted future cash flows.'
                                }, 'https://www.investopedia.com/terms/e/enterprisevalue.asp')}
                            </div>
                            <div class="result-value">${formatMoney(results.enterprise_value_dcf)}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('Equity Value', {
                                    formula: 'Equity Value = Enterprise Value - Total Debt + Cash',
                                    components: {
                                        enterprise_value: results.enterprise_value_dcf,
                                        total_debt: company.total_debt,
                                        cash: company.cash,
                                        equity_value: results.equity_value
                                    },
                                    explanation: 'The value attributable to shareholders after accounting for debt and cash.'
                                }, 'https://www.investopedia.com/terms/m/marketvalue.asp')}
                            </div>
                            <div class="result-value">${formatMoney(results.equity_value)}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('Terminal Value', details.terminal_value || {}, 'https://www.investopedia.com/terms/t/terminalvalue.asp')}
                            </div>
                            <div class="result-value">${formatMoney(results.terminal_value)}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">
                                ${createTooltip('EV/FCF Multiple', {
                                    explanation: 'How many years of current free cash flow it would take to pay for the enterprise value. Lower is generally better.'
                                }, 'https://www.investopedia.com/terms/e/ev-fcf.asp')}
                            </div>
                            <div class="result-value">${formatMultiple(results.ev_fcf_multiple)}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">ðŸ“ˆ Historical Performance (Last 12 Quarters)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Quarter</th>
                                <th>${createTooltip('Operating CF', details.fcf || {}, 'https://www.investopedia.com/terms/o/operatingcashflow.asp')}</th>
                                <th>${createTooltip('CapEx', {
                                    explanation: 'Capital Expenditures - money spent on maintaining/upgrading physical assets like buildings and equipment.'
                                }, 'https://www.investopedia.com/terms/c/capitalexpenditure.asp')}</th>
                                <th>${createTooltip('Free Cash Flow', details.fcf || {}, 'https://www.investopedia.com/terms/f/freecashflow.asp')}</th>
                                <th>Net Income</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.historical_data.quarters.map((q, i) => {
                                const ocf = results.historical_data.operating_cash_flow[i];
                                const capex = results.historical_data.capex[i];
                                const fcf = results.historical_metrics.quarterly_fcf[i];
                                const ni = results.historical_data.net_income[i] || 0;
                                return `
                                <tr>
                                    <td><strong>${q}</strong></td>
                                    <td>${formatMoney(ocf)}</td>
                                    <td>${formatMoney(capex)}</td>
                                    <td><strong>${formatMoney(fcf)}</strong></td>
                                    <td>${formatMoney(ni)}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="info-box">
                        <p><strong>TTM Operating Cash Flow:</strong> ${formatMoney(results.historical_metrics.ttm_operating_cf)}</p>
                        <p><strong>TTM Free Cash Flow:</strong> ${formatMoney(results.historical_metrics.ttm_fcf)}</p>
                        <p><strong>TTM Net Income:</strong> ${formatMoney(results.historical_metrics.ttm_net_income)}</p>
                    </div>
                </div>

                ${esgHtml}
                ${stressHtml}
                ${sensitivityHtml}

                <div class="section">
                    <h2 class="section-title">ðŸ”® Projected Free Cash Flows (5-Year Forecast)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Projected FCF ($M)</th>
                                <th>${createTooltip('Discount Factor', {
                                    explanation: 'The factor used to convert future cash flows to present value. Higher discount rates (WACC) result in lower present values.'
                                }, 'https://www.investopedia.com/terms/d/discountrate.asp')}</th>
                                <th>${createTooltip('Present Value', {
                                    explanation: 'The value today of future cash flows, adjusted for the time value of money using WACC as the discount rate.'
                                }, 'https://www.investopedia.com/terms/p/presentvalue.asp')}</th>
                                <th>Growth Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.projected_fcf.map((fcf, i) => {
                                const year = i + 1;
                                const discount = 1 / Math.pow(1 + results.wacc_results.wacc, year);
                                const pv = results.pv_fcf[i];
                                const growth = results.assumptions.revenue_growth_rates[i];
                                return `
                                    <tr>
                                        <td><strong>Year ${year}</strong></td>
                                        <td>${formatMoney(fcf)}</td>
                                        <td>${discount.toFixed(4)}</td>
                                        <td><strong>${formatMoney(pv)}</strong></td>
                                        <td>${(growth * 100).toFixed(1)}%</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background-color: #e7f3ff; font-weight: bold;">
                                <td><strong>Terminal Value</strong></td>
                                <td>${formatMoney(results.terminal_value)}</td>
                                <td>${(1 / Math.pow(1 + results.wacc_results.wacc, 5)).toFixed(4)}</td>
                                <td><strong>${formatMoney(results.pv_terminal_value)}</strong></td>
                                <td>${(results.assumptions.perpetual_growth_rate * 100).toFixed(1)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Consolidated Financial Data Section with Quality Indicators
            const quality = results.data_quality || {};
            const raw = results.raw_financials || {};

            let qualityHTML = `
                <div class="section">
                    <h2 class="section-title">
                        ðŸ“‹ Consolidated Financial Data
                        <span style="font-size: 0.6em; margin-left: 10px;">
                            ${quality.quality_emoji || 'â“'} Data Quality: ${quality.quality || 'Unknown'}
                        </span>
                    </h2>

                    <!-- Data Quality Alerts -->
                    ${quality.issues && quality.issues.length > 0 ? `
                        <div class="info-box danger">
                            <p><strong>âš ï¸ Critical Data Issues:</strong></p>
                            ${quality.issues.map(issue => `<p>â€¢ ${issue}</p>`).join('')}
                        </div>
                    ` : ''}

                    ${quality.warnings && quality.warnings.length > 0 ? `
                        <div class="info-box warning">
                            <p><strong>âš ï¸ Data Quality Warnings:</strong></p>
                            ${quality.warnings.map(warning => `<p>â€¢ ${warning}</p>`).join('')}
                        </div>
                    ` : ''}

                    ${quality.quality === 'EXCELLENT' ? `
                        <div class="info-box">
                            <p><strong>âœ… Excellent Data Quality</strong></p>
                            <p>All financial data successfully loaded and validated.</p>
                        </div>
                    ` : ''}

                    <!-- Balance Sheet Data -->
                    <h3 style="margin-top: 30px; color: #1e3c72; font-size: 1.4em;">Balance Sheet (as of ${raw.balance_sheet_date || 'N/A'})</h3>
                    <div class="results-grid">
                        <div class="result-card ${company.cash > 0 ? '' : 'negative'}">
                            <div class="result-label">Cash & Equivalents</div>
                            <div class="result-value ${company.cash > 0 ? '' : 'negative'}">
                                ${formatMoney(company.cash)}
                            </div>
                            ${company.cash === 0 ? '<p style="font-size:0.75em;color:#ef4444;margin-top:5px;">âš ï¸ Zero value detected</p>' : ''}
                        </div>

                        <div class="result-card ${company.total_debt >= 0 ? '' : 'negative'}">
                            <div class="result-label">Total Debt</div>
                            <div class="result-value">${formatMoney(company.total_debt)}</div>
                            ${company.total_debt === 0 ? '<p style="font-size:0.75em;color:#f59e0b;margin-top:5px;">âš ï¸ Zero debt (unusual)</p>' : ''}
                        </div>

                        <div class="result-card">
                            <div class="result-label">Short-Term Debt</div>
                            <div class="result-value">${formatMoney(company.short_term_debt || 0)}</div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Long-Term Debt</div>
                            <div class="result-value">${formatMoney(company.long_term_debt || 0)}</div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Total Assets</div>
                            <div class="result-value">${formatMoney(company.total_assets || 0)}</div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Total Liabilities</div>
                            <div class="result-value">${formatMoney(company.total_liabilities || 0)}</div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Shareholders' Equity</div>
                            <div class="result-value">${formatMoney(company.shareholders_equity || 0)}</div>
                        </div>

                        <div class="result-card ${company.shares_outstanding > 0 ? '' : 'negative'}">
                            <div class="result-label">Shares Outstanding</div>
                            <div class="result-value ${company.shares_outstanding > 0 ? '' : 'negative'}">
                                ${Math.round(company.shares_outstanding).toLocaleString('en-US')}M
                            </div>
                            ${company.shares_outstanding === 0 ? '<p style="font-size:0.75em;color:#ef4444;margin-top:5px;">âŒ Missing!</p>' : ''}
                        </div>
                    </div>

                    <!-- Key Ratios from Balance Sheet -->
                    <h3 style="margin-top: 30px; color: #1e3c72; font-size: 1.4em;">Key Financial Ratios</h3>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">Net Debt</div>
                            <div class="result-value">
                                ${formatMoney(company.total_debt - company.cash)}
                            </div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Debt-to-Equity Ratio</div>
                            <div class="result-value">
                                ${company.shareholders_equity > 0 ? (company.total_debt / company.shareholders_equity).toFixed(2) + 'x' : 'N/A'}
                            </div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Current Price</div>
                            <div class="result-value">$${results.current_market_value.toFixed(2)}</div>
                        </div>

                        <div class="result-card">
                            <div class="result-label">Market Cap</div>
                            <div class="result-value">${formatMoney(results.wacc_results.market_cap)}</div>
                        </div>
                    </div>

                    <!-- Cash Flow Summary -->
                    <h3 style="margin-top: 30px; color: #1e3c72; font-size: 1.4em;">Cash Flow Summary (TTM)</h3>
                    <div class="results-grid">
                        <div class="result-card ${results.historical_metrics.ttm_operating_cf > 0 ? 'positive' : 'negative'}">
                            <div class="result-label">Operating Cash Flow</div>
                            <div class="result-value ${results.historical_metrics.ttm_operating_cf > 0 ? 'positive' : 'negative'}">
                                ${formatMoney(results.historical_metrics.ttm_operating_cf)}
                            </div>
                            ${results.historical_metrics.ttm_operating_cf === 0 ? '<p style="font-size:0.75em;color:#ef4444;margin-top:5px;">âŒ Zero OCF!</p>' : ''}
                        </div>

                        <div class="result-card">
                            <div class="result-label">Capital Expenditures</div>
                            <div class="result-value">
                                ${formatMoney(results.historical_metrics.ttm_capex)}
                            </div>
                            ${results.historical_metrics.ttm_capex === 0 ? '<p style="font-size:0.75em;color:#f59e0b;margin-top:5px;">âš ï¸ No CapEx reported</p>' : ''}
                        </div>

                        <div class="result-card ${results.historical_metrics.ttm_fcf > 0 ? 'positive' : 'negative'}">
                            <div class="result-label">Free Cash Flow</div>
                            <div class="result-value ${results.historical_metrics.ttm_fcf > 0 ? 'positive' : 'negative'}">
                                ${formatMoney(results.historical_metrics.ttm_fcf)}
                            </div>
                        </div>

                        <div class="result-card ${results.historical_metrics.ttm_net_income > 0 ? 'positive' : 'negative'}">
                            <div class="result-label">Net Income</div>
                            <div class="result-value ${results.historical_metrics.ttm_net_income > 0 ? 'positive' : 'negative'}">
                                ${formatMoney(results.historical_metrics.ttm_net_income)}
                            </div>
                        </div>
                    </div>

                    <!-- Data Source Information -->
                    <div class="info-box" style="margin-top: 30px;">
                        <p><strong>ðŸ“Š Data Sources:</strong></p>
                        <p>â€¢ Balance Sheet: Alpha Vantage API (Quarter ending ${raw.balance_sheet_date || 'N/A'})</p>
                        <p>â€¢ Cash Flow: Last 12 quarters from quarterly reports</p>
                        <p>â€¢ Market Data: Real-time quote from Alpha Vantage</p>
                        ${quality.usable ?
                            '<p style="color: #10b981; margin-top: 10px;"><strong>âœ… Data is complete and suitable for DCF analysis</strong></p>' :
                            '<p style="color: #ef4444; margin-top: 10px;"><strong>âš ï¸ Data has issues - DCF results may be unreliable</strong></p>'
                        }
                    </div>
                </div>
            `;

            container.innerHTML += qualityHTML;
        }

        function displaySentimentFeed(results) {
            const container = document.getElementById('sentiment-content');
            const reddit = results.reddit_sentiment || {};
            const news = results.news_analysis || {};

            let html = '';

            // Overall Sentiment Summary
            const avgSentiment = ((reddit.sentiment_percentage || 50) + (news.sentiment_percentage || 50)) / 2;
            let sentimentClass = 'neutral';
            let sentimentEmoji = 'ðŸ˜';
            
            if (avgSentiment >= 60) {
                sentimentClass = 'positive';
                sentimentEmoji = 'ðŸ˜Š';
            } else if (avgSentiment <= 40) {
                sentimentClass = 'negative';
                sentimentEmoji = 'ðŸ˜Ÿ';
            }

            html += `
                <div class="sentiment-card">
                    <div class="header">
                        <span class="source">Overall Sentiment</span>
                        <span class="score">${sentimentEmoji}</span>
                    </div>
                    <div class="sentiment-gauge">
                        <div class="sentiment-gauge-fill ${sentimentClass}" style="width: ${avgSentiment}%"></div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        ${avgSentiment.toFixed(0)}% positive sentiment across ${(reddit.total_posts || 0) + (news.total_articles || 0)} sources
                    </p>
                </div>
            `;

            // Reddit Sentiment
            if (reddit.total_posts > 0) {
                let redditClass = 'neutral';
                if (reddit.sentiment_percentage >= 60) redditClass = 'positive';
                if (reddit.sentiment_percentage <= 40) redditClass = 'negative';

                html += `
                    <div class="sentiment-card">
                        <div class="header">
                            <span class="source">ðŸ“± Reddit</span>
                            <span style="font-size: 0.85em;">${reddit.analyzed_posts} posts</span>
                        </div>
                        <div class="sentiment-gauge">
                            <div class="sentiment-gauge-fill ${redditClass}" style="width: ${reddit.sentiment_percentage}%"></div>
                        </div>
                        ${reddit.post_highlights && reddit.post_highlights.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${reddit.post_highlights.slice(0, 3).map(post => `
                                    <div class="reddit-item">
                                        <div class="title">${post.title}</div>
                                        <div class="meta">
                                            r/${post.subreddit} â€¢ ${post.sentiment} â€¢ ${post.score} upvotes
                                            <a href="${post.url}" target="_blank">View â†’</a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // News Sentiment
            if (news.total_articles > 0) {
                let newsClass = 'neutral';
                if (news.sentiment_percentage >= 60) newsClass = 'positive';
                if (news.sentiment_percentage <= 40) newsClass = 'negative';

                html += `
                    <div class="sentiment-card">
                        <div class="header">
                            <span class="source">ðŸ“° News</span>
                            <span style="font-size: 0.85em;">${news.analyzed_articles} articles</span>
                        </div>
                        <div class="sentiment-gauge">
                            <div class="sentiment-gauge-fill ${newsClass}" style="width: ${news.sentiment_percentage}%"></div>
                        </div>
                    </div>
                `;

                // Risk Flags
                if (news.risk_flags && news.risk_flags.length > 0) {
                    html += `
                        <div class="sentiment-card">
                            <div class="header">
                                <span class="source">âš ï¸ Risk Alerts</span>
                            </div>
                            ${news.risk_flags.map(risk => `
                                <div class="news-item">
                                    <div class="title">${risk.title}</div>
                                    <div class="meta">
                                        ${risk.source} â€¢ ${new Date(risk.date).toLocaleDateString()}
                                        <a href="${risk.url}" target="_blank">Read â†’</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Opportunity Flags
                if (news.opportunity_flags && news.opportunity_flags.length > 0) {
                    html += `
                        <div class="sentiment-card">
                            <div class="header">
                                <span class="source">ðŸŒŸ Opportunities</span>
                            </div>
                            ${news.opportunity_flags.map(opp => `
                                <div class="news-item">
                                    <div class="title">${opp.title}</div>
                                    <div class="meta">
                                        ${opp.source} â€¢ ${new Date(opp.date).toLocaleDateString()}
                                        <a href="${opp.url}" target="_blank">Read â†’</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        // Allow Enter key to trigger analysis
        document.getElementById('ticker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        const esgStrengthInput = document.getElementById('esg-strength-bps');
        const esgStrengthValue = document.getElementById('esg-strength-value');
        if (esgStrengthInput && esgStrengthValue) {
            esgStrengthValue.textContent = esgStrengthInput.value;
            esgStrengthInput.addEventListener('input', function(e) {
                esgStrengthValue.textContent = e.target.value;
            });
        }

        // Focus on ticker input on load
        window.onload = function() {
            document.getElementById('ticker').focus();
        };
    </script>
</body>
</html>
